<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simulation output</title>

    <style>

        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }

        .agent-box {
            fill: #297baa;
            stroke: #0D3349;
            stroke-width: 1px;
        }

        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .grid path {
            stroke-width: 0;
        }

    </style>

</head>

<body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.11/d3.min.js"></script>

    <script type="text/javascript" src="socket.io-client/dist/socket.io.js"></script>
    <script type="text/javascript" src="symple-client/dist/symple.js"></script>
    <!--<script type="text/javascript" src="connect.js"></script>-->


    <div class="sim-meta-data">
        <span id='time'>Initializing ...</span>
    </div>
    <div id="sim-canvas">

    </div>

    <script type="application/javascript">

        $( document ).ready(() => {

            //client.disconnect();
            // connection.send(msg);

        })

    </script>


    <script type="application/javascript">


        var log = false;
        var counter = 0;
        var svg = false;

        var i = 0;
        setInterval(function() {

            /*$.ajax({
                dataType: "json",
                url: '../../log/live.json',
                data: '',
                cache : false,
                success: (res, err) => {
                    if(!log) {
                        log = res;
                    } else {
                        log.time = res.time;
                        log.agents = res.agents;
                    }
                },
                error : (res, err) => {
                    log = false;
                }
            });*/

            var p = i * 0.1 * Math.PI;

            log = {};
            log.size = {x0 : -120.0, x1 : 120.0, y0 : -120, y1 : 120.0};
            log.agents = [
                {x : (i + 10) % 200, y : 50 + Math.sin(p), psi : Math.atan2(0.25 * Math.cos(p), 1), width : 2.2, length : 5.0 },
                {x : (i + 20) % 200, y : 50 + Math.sin(p), psi : Math.atan2(0.25 * Math.cos(p), 1), width : 2.2, length : 5.0 },
                {x : (i + 50) % 200, y : 50 + Math.sin(p), psi : Math.atan2(0.25 * Math.cos(p), 1), width : 2.2, length : 5.0 },
                {x : (i + 70) % 200, y : 50 + Math.sin(p), psi : Math.atan2(0.25 * Math.cos(p), 1), width : 2.2, length : 5.0 }
            ];

            i++;

        }, 100);

        setInterval(function(){

            counter++;

            // check if time info is available and update time
            if(log !== false) {

                d3.select('#time')
                    .html(log.time);

                if(!svg) {

                    var ratio  = (log.size.y1 - log.size.y0) / (log.size.x1 - log.size.x0);
                    var width  = 1000;
                    var height = width * ratio;


                    svg = {};
                    svg.container = d3.select("#sim-canvas")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height);

                    svg.x_scale = d3.scale.linear()
                        .domain([log.size.x0, log.size.x1])
                        .range([40, width - 20]);

                    svg.s_scale = d3.scale.linear()
                        .domain([0.0, log.size.x1 - log.size.x0])
                        .range([0.0, width - 60]);

                    svg.y_scale = d3.scale.linear()
                        .domain([log.size.y0, log.size.y1])
                        .range([height - 20, 40]);

                    svg.x_axis = d3.svg.axis()
                        .scale(svg.x_scale)
                        .orient("bottom");

                    svg.y_axis = d3.svg.axis()
                        .scale(svg.y_scale)
                        .orient("left");

                    svg.container.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(0," + (height - 20) + ")")
                        .call(svg.x_axis);

                    svg.container.append("g")
                        .attr("class", "axis")
                        .attr("transform", "translate(40,0)")
                        .call(svg.y_axis);

                }


                svg.agents = svg.container
                    .selectAll("rect")
                    .data(log.agents);

                svg.agents
                    .exit()
                    .remove();

                svg.agents
                    .enter()
                    .append("rect")
                    .attr("x", (d) => { return svg.x_scale(d.x - d.length * 0.5); })
                    .attr("y", (d) => { return svg.y_scale(d.y + d.width * 0.5); })
                    .attr("width",  (d) => { return svg.s_scale(d.length); })
                    .attr("height", (d) => { return svg.s_scale(d.width); })
                    .attr("rx", svg.s_scale(0.2))
                    .attr("ry", svg.s_scale(0.2))
                    .attr("class", "agent-box");

                svg.agents
                    .attr('x', (d) => { return svg.x_scale(d.x - d.length * 0.5); })
                    .attr('y', (d) => { return svg.y_scale(d.y + d.width * 0.5); })
                    .attr("transform", (d) => { return "rotate(" + (-d.psi * 180.0 / Math.PI) + "," + svg.x_scale(d.x) + "," + svg.y_scale(d.y) + ")"; });

                // TODO: transition()

            } else {

                svg = false;
                $("#sim-canvas").empty();

                d3.select('#time')
                    .html("no data available yet. (" + counter + ")");

            }

        }, 25);

    </script>

</body>
</html>